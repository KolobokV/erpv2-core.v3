services:
  mariadb:
    image: mariadb:10.11
    restart: unless-stopped
    env_file: .env
    environment:
      - MARIADB_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MARIADB_DATABASE=${MYSQL_DATABASE}
      - MARIADB_USER=${MYSQL_USER}
      - MARIADB_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -p${MYSQL_ROOT_PASSWORD} --silent"]
      interval: 10s
      timeout: 5s
      retries: 30

  dolibarr:
    image: tuxgasy/dolibarr:17.0.4
    restart: unless-stopped
    depends_on:
      mariadb:
        condition: service_healthy
    env_file: .env
    environment:
      - DOLI_DB_HOST=${DOLI_DB_HOST}
      - DOLI_DB_NAME=${DOLI_DB_NAME}
      - DOLI_DB_USER=${DOLI_DB_USER}
      - DOLI_DB_PASSWORD=${DOLI_DB_PASSWORD}
      - DOLI_URL_ROOT=${DOLI_URL_ROOT}
      - DOLI_INIT_DEMO=${DOLI_INIT_DEMO}
      - DOLI_ADMIN_LOGIN=${DOLI_ADMIN_LOGIN}
      - DOLI_ADMIN_PASSWORD=${DOLI_ADMIN_PASSWORD}
      - DOLI_COMPANY_NAME=${DOLI_COMPANY_NAME}
      - DOLI_CRON=${DOLI_CRON}
      - DOLI_CRON_KEY=${DOLI_CRON_KEY}
    ports:
      - "8282:80"
    volumes:
      - doli_docs:/var/www/documents
      - ./init:/var/www/html/custom/init
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/ > /dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 60

volumes:
  db_data: {}
  doli_docs: {}
